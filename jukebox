#!/bin/sh
# config
set -e
music_folder="Music"
cd ~/$music_folder/.tmp/dl

# lastfm
username=polarhive
type=mix

# cache json
response=$(curl -s "https://www.last.fm/player/station/user/${username}/${type}")
length=$(jq -r '.playlist | length' <<< "$response")

# queue songs
for ((i=0; i<length; i++))
do
    # parse json
    id="$(jq -r ".playlist[$i].playlinks[0].id" <<< "$response")"
    a="$(jq -r ".playlist[$i].artists[0].name" <<< "$response")"
    t="$(jq -r ".playlist[$i].name" <<< "$response")"

    # ytdl
    yt-dlp --postprocessor-args "ffmpeg":"-metadata title='$t' -metadata artist='$a'" -f 'ba' -x --ignore-config -q --progress --restrict-filenames "$id" || break

    # mpc
    rm ~/$music_folder/.tmp/dl/*.part -f
    name=$(ls -u | head -1)
    mpc -q update
    mpc -q add ".tmp/dl/${name}"
    mpc -q play

    # log
    echo "queueing: $t — $a"
    notify-send "queueing: $t — $a"
done
